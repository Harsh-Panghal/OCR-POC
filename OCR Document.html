<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer with Accurate OCR</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f3f4f6;
            overflow: hidden; /* Main body scroll hide kiya */
        }

        /* Top Bar */
        .top-bar {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 20px; 
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Fixed Width Text Panel to prevent horizontal scroll on PDF */
        #textPanel {
            width: 250px; /* Width reduced */
            min-width: 250px;
            overflow-y: auto;
            border-right: 1px solid #d1d5db;
            padding: 15px;
            background: #ffffff;
        }

        #textPanel h3 {
            font-size: 1rem;
            margin-top: 0;
            color: #1e40af;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* PDF Panel taking remaining space */
        #pdfPanel {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: auto; /* Just in case, but width reduction should fix it */
            position: relative;
            background: #525659;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* Improved Scrollbar - Minimal & Auto-hide feel */
        #textPanel::-webkit-scrollbar, 
        #pdfPanel::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        #textPanel::-webkit-scrollbar-thumb, 
        #pdfPanel::-webkit-scrollbar-thumb {
            background: transparent; /* Default hidden */
            border-radius: 10px;
        }

        /* Visible on hover */
        #textPanel:hover::-webkit-scrollbar-thumb, 
        #pdfPanel:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2); 
        }

        #pdfPanel:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); /* Light scrollbar for dark PDF background */
        }

        .text-line {
            cursor: pointer;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.4;
            transition: all 0.2s ease;
            word-wrap: break-word;
        }

        .text-line:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            transform: translateX(3px);
        }

        .page {
            position: relative;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            background: white;
        }

        canvas {
            display: block;
        }

        .highlight {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.25);
            pointer-events: none;
            border-radius: 2px;
        }

        .btn-refresh {
            padding: 6px 14px;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-refresh:hover {
            background: #2563eb;
        }
    </style>
</head>

<body style="overflow-wrap: break-word;" onload="OnLoad()">

    <div class="top-bar">
        <div style="font-size: 14px; font-weight: 600; color: #64748b;">OCR Utility</div>
        <button class="btn-refresh" onclick="refreshPage()">Refresh</button>
    </div>

    <div class="main-container">
        <div id="textPanel">
            <h3>Extracted Text</h3>
        </div>

        <div id="pdfPanel"></div>
    </div>

    <script>
        /* --- Logic & Comments Intact --- */

        function refreshPage() {
            location.reload();
        }

        const SCALE = 2;

        let pdfUrl = "./5a312567-5db9-f011-bbd3-7c1e521d650e_7d48cf8c-1bea-f011-8406-6045bd0e6caa_05012026113514.pdf";

        // 🔴 Hardcoded JSON
        const filterJson = [
            { "Job number": "45800" },
            { "VEHICLE REG NO": "NJ22AOV" },
            { "Chasis REG NO": "UN03385735" },
            { "Serial No": "10713439" },
        ];

        let filterValues = [];

        const shownValues = new Set();
        const pageWrappers = {};

        pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

        var _Xrm;
        var _formContext;

        async function OnLoad() { //Xrm, formContext) {
            debugger;
            try {
                //if (Xrm != null && Xrm != undefined)
                //    _Xrm = Xrm;
                //else
                //    _Xrm = window.parent.Xrm;

                //if (formContext != null && formContext != undefined)
                //    _formContext = formContext;
                //else
                //    _formContext = window.parent.Xrm.Page.ui.formContext;

                //let filterJson = null;

                //const attr = _formContext.getAttribute("ogre_document_key_values");

                //if (attr) {
                //    const value = attr.getValue();

                //    if (value && value.trim() !== "") {
                //        try {
                //            filterJson = JSON.parse(value);
                //        } catch (e) {
                //            console.error("Invalid JSON in ogre_document_key_values field:", e);
                //            return;
                //        }
                //    }
                //}

                //let recordId = _formContext.data.entity.getId();

                //if (recordId) {
                //    recordId = recordId.replace(/[{}]/g, "");
                //}

                // pdfUrl = `https://ogre-dev.crm11.dynamics.com/api/data/v9.0/ogre_ocrdocuments(${recordId})/ogre_file/$value`;

                filterValues = filterJson.map(obj => {
                    const key = Object.keys(obj)[0];
                    const value = Object.values(obj)[0];

                    return {
                        key: key,
                        value: value.toString().trim().toLowerCase()
                    };
                });

                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPage(page);
                    await extractText(page);
                }
            } catch (e) {
                // SetStatus("Unknown problem occurred. Error: " + e);
                console.log(e);
            }
        }

        /* ================= RENDER PAGE ================= */

        async function renderPage(page) {
            const viewport = page.getViewport({ scale: SCALE });
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const wrapper = document.createElement("div");
            wrapper.className = "page";
            wrapper.appendChild(canvas);

            document.getElementById("pdfPanel").appendChild(wrapper);
            pageWrappers[page.pageNumber] = wrapper;

            await page.render({ canvasContext: ctx, viewport }).promise;
        }

        /* ================= TEXT EXTRACTION ================= */

        async function extractText(page) {
            const viewport = page.getViewport({ scale: SCALE });
            const textContent = await page.getTextContent();

            if (textContent.items.length > 0) {
                extractNormalPDFText(page, textContent, viewport);
            } else {
                await extractScannedPDFText(page);
            }
        }

        /* ================= NORMAL PDF ================= */

        function extractNormalPDFText(page, tc, viewport) {

            tc.items.forEach(item => {

                if (!item.str.trim()) return;

                const pdfText = item.str.trim();
                const normalizedPdfText = pdfText.toLowerCase();

                // 🔴 JSON match check
                const matchObj = filterValues.find(f => f.value === normalizedPdfText);
                if (!matchObj) return;

                // 🔴 Duplicate control
                if (shownValues.has(matchObj.key)) return;
                shownValues.add(matchObj.key);


                const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                const left = tx[4];
                const top = tx[5] - item.height * SCALE;
                const width = item.width * SCALE;
                const height = item.height * SCALE;

                createTextLine(
                    page.pageNumber,
                    matchObj.key + " : " + pdfText,
                    left,
                    top,
                    width,
                    height
                );

            });
        }

        /* ================= OCR PDF ================= */

        async function extractScannedPDFText(page) {

            const canvas = pageWrappers[page.pageNumber].querySelector("canvas");
            preprocessCanvas(canvas);

            const worker = await Tesseract.createWorker("eng");
            await worker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/-",
                preserve_interword_spaces: "1"
            });

            const { data } = await worker.recognize(canvas);
            await worker.terminate();

            data.words.forEach(w => {

                const pdfText = w.text.trim();
                if (!pdfText) return;

                const normalizedPdfText = pdfText.toLowerCase();

                if (!filterValues.includes(normalizedPdfText)) return;

                if (shownValues.has(normalizedPdfText)) return;
                shownValues.add(normalizedPdfText);

                createTextLine(
                    page.pageNumber,
                    pdfText,
                    w.bbox.x0,
                    w.bbox.y0,
                    w.bbox.x1 - w.bbox.x0,
                    w.bbox.y1 - w.bbox.y0
                );
            });
        }

        /* ================= IMAGE PREPROCESS ================= */

        function preprocessCanvas(canvas) {

            const ctx = canvas.getContext("2d");
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const d = imgData.data;

            for (let i = 0; i < d.length; i += 4) {
                const gray = d[i] * 0.3 + d[i + 1] * 0.59 + d[i + 2] * 0.11;
                const val = gray > 160 ? 255 : 0;
                d[i] = d[i + 1] = d[i + 2] = val;
            }

            ctx.putImageData(imgData, 0, 0);
        }

        /* ================= UI ================= */

        function createTextLine(page, text, left, top, width, height) {

            const div = document.createElement("div");
            div.className = "text-line";
            div.textContent = text;

            div.onclick = () => highlight(page, left, top, width, height);

            document.getElementById("textPanel").appendChild(div);
        }

        function highlight(page, left, top, width, height) {

            const wrapper = pageWrappers[page];

            wrapper.querySelectorAll(".highlight").forEach(h => h.remove());

            const h = document.createElement("div");
            h.className = "highlight";

            h.style.left = left + "px";
            h.style.top = top + "px";
            h.style.width = width + "px";
            h.style.height = height + "px";

            wrapper.appendChild(h);

            h.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    </script>

</body>
</html>