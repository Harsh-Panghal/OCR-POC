<html>
  <head>
    <meta charset="UTF-8" />
    <title>PDF Viewer with Accurate OCR</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        font-family: "Segoe UI", Arial, sans-serif;
        background-color: #f3f4f6;
        overflow: hidden;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 20px;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }

      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      #textPanel {
        width: 280px;
        min-width: 280px;
        overflow-y: auto;
        border-right: 1px solid #d1d5db;
        padding: 15px;
        background: #ffffff;
      }

      #textPanel h3 {
        font-size: 0.9rem;
        margin-top: 0;
        color: #1e40af;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 8px;
        margin-bottom: 15px;
      }

      #pdfPanel {
        flex-grow: 1;
        overflow-y: auto;
        position: relative;
        background: #525659;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      /* --- Skeleton Animation --- */
      .skeleton {
        height: 40px;
        margin-bottom: 12px;
        background: linear-gradient(
          90deg,
          #f1f5f9 25%,
          #e2e8f0 50%,
          #f1f5f9 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* --- Toast Styling --- */
      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #10b981;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 100;
        right: 30px;
        bottom: 30px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      }
      #toast.show {
        visibility: visible;
        animation:
          fadein 0.5s,
          fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      /* --- Improved Scrollbars --- */
      #textPanel::-webkit-scrollbar,
      #pdfPanel::-webkit-scrollbar {
        width: 6px;
      }
      #textPanel::-webkit-scrollbar-thumb,
      #pdfPanel::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 10px;
      }
      #textPanel:hover::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
      }
      #pdfPanel:hover::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
      }

      /* --- Vertical Layout Field --- */
      .text-line {
        padding: 10px 10px 14px 10px; /* Bottom padding to fit progress bar */
        margin-bottom: 15px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 13px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        position: relative;
        overflow: hidden; /* For progress bar border-radius */
      }

      .text-line strong {
        color: #64748b;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        pointer-events: none;
      }

      /* Editable Value Box */
      .val-content {
        display: block;
        width: 100%;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #f1f5f9;
        outline: none;
        transition: all 0.2s;
        word-break: break-all;
        background: #f8fafc;
        box-sizing: border-box;
        color: #1e293b;
        font-weight: 500;
      }

      .val-content:focus {
        background: #ffffff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .text-line.is-edited {
        border-left: 4px solid #6366f1; /* Indigo border */
        background: #eef2ff; /* Very light indigo background */
      }

      .text-line.is-edited .val-content {
        border-color: #c7d2fe;
      }

      /* --- Confidence Progress Bar --- */
      .confidence-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        transition: width 0.3s ease;
      }
      .conf-high {
        background-color: #10b981;
      } /* Green */
      .conf-medium {
        background-color: #f59e0b;
      } /* Yellow */
      .conf-low {
        background-color: #ef4444;
      } /* Red */

      /* --- PDF Area --- */
      .page {
        position: relative;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        background: white;
      }

      canvas {
        display: block;
      }

      .highlight {
        position: absolute;
        border: 2px solid #3b82f6;
        background: rgba(59, 130, 246, 0.25);
        pointer-events: none;
        border-radius: 2px;
      }

      /* --- Buttons --- */
      .btn-refresh,
      .btn-save {
        padding: 8px 16px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        transition: 0.2s;
      }
      .btn-refresh {
        background: #f1f5f9;
        color: #475569;
      }
      .btn-refresh:hover {
        background: #e2e8f0;
      }
      .btn-save {
        background: #10b981;
        color: white;
        margin-left: 8px;
      }
      .btn-save:disabled {
        background: #cbd5e1;
        color: #94a3b8;
        cursor: not-allowed;
      }
      .btn-save:not(:disabled):hover {
        background: #059669;
        transform: translateY(-1px);
      }
    </style>
  </head>

  <body onload="OnLoad()">
    <div class="top-bar">
      <div style="font-size: 14px; font-weight: 700; color: #1e40af">
        OGRE OCR VIEWER
      </div>
      <div>
        <button class="btn-refresh" onclick="refreshPage()">Refresh</button>
        <button id="saveBtn" class="btn-save" onclick="handleSave()" disabled>
          Save Changes
        </button>
      </div>
    </div>

    <div class="main-container">
      <div id="textPanel">
        <h3>Extracted Text</h3>
        <div id="skeleton-container"></div>
      </div>
      <div id="pdfPanel"></div>
    </div>

    <div id="toast">Changes Saved Successfully!</div>

    <script>
      function refreshPage() {
        location.reload();
      }

      const SCALE = 2;
      let pdfUrl =
        "./5a312567-5db9-f011-bbd3-7c1e521d650e_7d48cf8c-1bea-f011-8406-6045bd0e6caa_05012026113514.pdf";

      // Include dummy confidence values for UI demonstration
      const filterJson = [
        { "Job no": "NJ22AOV", confidence: 0.95 },
        { "VEHICLE REG NO": "45800", confidence: 0.65 },
        { "Chasis REG NO": "UN03385735", confidence: 0.4 },
        { "Serial No": "10713439", confidence: 0.88 },
      ];

      let filterValues = [];
      const shownValues = new Set();
      const pageWrappers = {};

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

      var _Xrm;
      var _formContext;

      // Skeleton UI Functions
      function showSkeletons() {
        const container = document.getElementById("skeleton-container");
        container.innerHTML = "";
        for (let i = 0; i < 6; i++) {
          const skel = document.createElement("div");
          skel.className = "skeleton";
          container.appendChild(skel);
        }
      }

      function hideSkeletons() {
        const container = document.getElementById("skeleton-container");
        if (container) container.style.display = "none";
      }

      // Toast Notification Function
      function showToast() {
        const x = document.getElementById("toast");
        x.className = "show";
        setTimeout(function () {
          x.className = x.className.replace("show", "");
        }, 3000);
      }

      // Clear all highlights globally
      function removeHighlights() {
        document.querySelectorAll(".highlight").forEach((h) => h.remove());
      }

      // Clear highlights when clicking empty PDF space
      document.getElementById("pdfPanel").addEventListener("click", (e) => {
        if (e.target.id === "pdfPanel" || e.target.className === "page") {
          removeHighlights();
        }
      });

      async function OnLoad() {
        //Xrm, formContext) {
        debugger;
        showSkeletons();
        try {
          //if (Xrm != null && Xrm != undefined)
          //    _Xrm = Xrm;
          //else
          //    _Xrm = window.parent.Xrm;

          //if (formContext != null && formContext != undefined)
          //    _formContext = formContext;
          //else
          //    _formContext = window.parent.Xrm.Page.ui.formContext;

          //let filterJson = null;

          //const attr = _formContext.getAttribute("ogre_document_key_values");

          //if (attr) {
          //    const value = attr.getValue();

          //    if (value && value.trim() !== "") {
          //        try {
          //            filterJson = JSON.parse(value);
          //        } catch (e) {
          //            console.error("Invalid JSON in ogre_document_key_values field:", e);
          //            return;
          //        }
          //    }
          //}

          //let recordId = _formContext.data.entity.getId();

          //if (recordId) {
          //    recordId = recordId.replace(/[{}]/g, "");
          //}

          // pdfUrl = `https://ogre-dev.crm11.dynamics.com/api/data/v9.0/ogre_ocrdocuments(${recordId})/ogre_file/$value`;

          filterValues = filterJson.map((obj) => {
            const key = Object.keys(obj)[0];
            const value = Object.values(obj)[0];
            const conf = obj.confidence || 1.0;
            return {
              key: key,
              value: value.toString().trim().toLowerCase(),
              confidence: conf,
            };
          });

          const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            await renderPage(page);
            await extractText(page);
          }
          hideSkeletons();
        } catch (e) {
          hideSkeletons();
          // SetStatus("Unknown problem occurred. Error: " + e);
          console.log(e);
        }
      }

      async function renderPage(page) {
        const viewport = page.getViewport({ scale: SCALE });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const wrapper = document.createElement("div");
        wrapper.className = "page";
        wrapper.appendChild(canvas);
        document.getElementById("pdfPanel").appendChild(wrapper);
        pageWrappers[page.pageNumber] = wrapper;
        await page.render({ canvasContext: ctx, viewport }).promise;
      }

      async function extractText(page) {
        const viewport = page.getViewport({ scale: SCALE });
        const textContent = await page.getTextContent();
        if (textContent.items.length > 0)
          extractNormalPDFText(page, textContent, viewport);
        else await extractScannedPDFText(page);
      }

      function extractNormalPDFText(page, tc, viewport) {
        tc.items.forEach((item) => {
          if (!item.str.trim()) return;
          const pdfText = item.str.trim();
          const normalizedPdfText = pdfText.toLowerCase();
          const matchObj = filterValues.find(
            (f) => f.value === normalizedPdfText,
          );

          if (!matchObj || shownValues.has(matchObj.key)) return;
          shownValues.add(matchObj.key);

          const tx = pdfjsLib.Util.transform(
            viewport.transform,
            item.transform,
          );

          createTextLine(
            page.pageNumber,
            matchObj.key,
            pdfText,
            matchObj.confidence,
            tx[4],
            tx[5] - item.height * SCALE,
            item.width * SCALE,
            item.height * SCALE,
          );
        });
      }

      async function extractScannedPDFText(page) {
        const canvas = pageWrappers[page.pageNumber].querySelector("canvas");
        preprocessCanvas(canvas);
        const worker = await Tesseract.createWorker("eng");
        await worker.setParameters({
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
          tessedit_char_whitelist:
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/-",
          preserve_interword_spaces: "1",
        });
        const { data } = await worker.recognize(canvas);
        await worker.terminate();
        data.words.forEach((w) => {
          const pdfText = w.text.trim();
          const normalizedPdfText = pdfText.toLowerCase();
          const matchObj = filterValues.find(
            (f) => f.value === normalizedPdfText,
          );

          if (!matchObj || shownValues.has(matchObj.key)) return;
          shownValues.add(matchObj.key);

          createTextLine(
            page.pageNumber,
            matchObj.key,
            pdfText,
            matchObj.confidence,
            w.bbox.x0,
            w.bbox.y0,
            w.bbox.x1 - w.bbox.x0,
            w.bbox.y1 - w.bbox.y0,
          );
        });
      }

      function preprocessCanvas(canvas) {
        const ctx = canvas.getContext("2d");
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
          const gray = d[i] * 0.3 + d[i + 1] * 0.59 + d[i + 2] * 0.11;
          const val = gray > 160 ? 255 : 0;
          d[i] = d[i + 1] = d[i + 2] = val;
        }
        ctx.putImageData(imgData, 0, 0);
      }

      function createTextLine(
        page,
        key,
        value,
        confidence,
        left,
        top,
        width,
        height,
      ) {
        const div = document.createElement("div");
        div.className = "text-line";
        div.setAttribute("data-key", key);
        div.setAttribute("data-original", value);
        div.setAttribute("data-confidence", confidence);

        // Progress Bar Logic
        let colorClass = "conf-high";
        if (confidence < 0.5) {
          colorClass = "conf-low";
        } else if (confidence < 0.8) {
          colorClass = "conf-medium";
        }
        const widthPercent = confidence * 100 + "%";

        // Inject HTML
        div.innerHTML = `
          <strong>${key}</strong> 
          <span class="val-content" contenteditable="true" spellcheck="false">${value}</span>
          <div class="confidence-bar ${colorClass}" style="width: ${widthPercent};" title="Confidence: ${widthPercent}"></div>
        `;

        // Unified Click & Focus
        div.onclick = (e) => {
          const span = div.querySelector(".val-content");
          if (document.activeElement !== span) {
            span.focus();
          }
          highlight(page, left, top, width, height);
        };

        const span = div.querySelector(".val-content");

        // Input monitoring
        span.oninput = () => {
          const currentVal = span.innerText.trim();
          const originalVal = div.getAttribute("data-original").trim();
          if (currentVal !== originalVal) div.classList.add("is-edited");
          else div.classList.remove("is-edited");
          checkEnableSave();
        };

        document.getElementById("textPanel").appendChild(div);
      }

      function checkEnableSave() {
        const hasChanges = document.querySelectorAll(".is-edited").length > 0;
        document.getElementById("saveBtn").disabled = !hasChanges;
      }

      function handleSave() {
        const updatedData = [];

        document.querySelectorAll(".text-line").forEach((div) => {
          const key = div.getAttribute("data-key");
          const value = div.querySelector(".val-content").innerText.trim();
          const confidence = parseFloat(div.getAttribute("data-confidence"));

          // Reconstruct the array of objects structure
          updatedData.push({
            [key]: value,
            confidence: confidence,
          });
        });

        console.log("Updated JSON:", JSON.stringify(updatedData, null, 2));

        // Show success notification
        showToast();

        // Reset state after save
        document.querySelectorAll(".is-edited").forEach((el) => {
          el.setAttribute(
            "data-original",
            el.querySelector(".val-content").innerText,
          );
          el.classList.remove("is-edited");
        });

        checkEnableSave();
      }

      function highlight(page, left, top, width, height) {
        const wrapper = pageWrappers[page];

        removeHighlights();

        const h = document.createElement("div");
        h.className = "highlight";
        h.style.left = left + "px";
        h.style.top = top + "px";
        h.style.width = width + "px";
        h.style.height = height + "px";

        wrapper.appendChild(h);
        h.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    </script>
  </body>
</html>
